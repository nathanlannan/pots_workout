<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>POTS Training Planner</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0f172a" />
  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --card2: #1f2937;
      --accent: #38bdf8;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --radius: 1.25rem;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0%, #020617 55%, #000 100%);
      min-height: 100vh;
      color: var(--text);
      display: flex;
      justify-content: center;
    }
    .app {
      width: min(960px, 100%);
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: .75rem;
    }
    h1 {
      font-size: 1.2rem;
      margin: 0;
    }
    .card {
      background: rgba(15, 23, 42, 0.7);
      border: 1px solid rgba(148, 163, 184, 0.12);
      border-radius: var(--radius);
      padding: 1rem;
      backdrop-filter: blur(14px);
    }
    label {
      font-size: .7rem;
      display: block;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--muted);
      margin-bottom: .35rem;
    }
    input[type="date"], select {
      background: rgba(15, 23, 42, 0.7);
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: .75rem;
      padding: .35rem .6rem;
      color: var(--text);
    }
    button {
      background: var(--accent);
      border: none;
      border-radius: .75rem;
      color: #020617;
      padding: .4rem .8rem;
      font-weight: 600;
      cursor: pointer;
    }
    .secondary-btn {
      background: rgba(148, 163, 184, 0.1);
      border: 1px solid rgba(148, 163, 184, 0.25);
      color: var(--text);
    }
    .today-title {
      font-size: .75rem;
      text-transform: uppercase;
      color: var(--muted);
      letter-spacing: 0.04em;
      margin-bottom: .4rem;
    }
    .today-name {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: .25rem;
    }
    .badge {
      display: inline-block;
      background: rgba(56,189,248,0.1);
      border: 1px solid rgba(56,189,248,0.4);
      color: #e2e8f0;
      font-size: .6rem;
      padding: .2rem .5rem;
      border-radius: 999px;
      margin-right: .5rem;
    }
    .session-title {
      font-weight: 600;
      margin-top: .5rem;
      margin-bottom: .25rem;
    }
    .session-line {
      font-size: .8rem;
      color: var(--muted);
      margin-bottom: .25rem;
    }
    .flex-row {
      display: flex;
      gap: .5rem;
      flex-wrap: wrap;
    }
    .week-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: .5rem;
      margin-top: .5rem;
    }
    .day-card {
      background: rgba(248, 250, 252, 0.01);
      border: 1px solid rgba(148, 163, 184, 0.08);
      border-radius: 1rem;
      padding: .6rem .6rem .7rem;
      cursor: pointer;
    }
    .day-card.active {
      border-color: rgba(56,189,248,0.9);
      background: rgba(15,23,42,0.4);
    }
    .day-name {
      font-size: .65rem;
      text-transform: uppercase;
      color: var(--muted);
    }
    .day-session {
      font-size: .75rem;
      font-weight: 600;
    }
    .small {
      font-size: .7rem;
      color: var(--muted);
    }
    footer {
      text-align: center;
      font-size: .65rem;
      color: #475569;
      margin-top: .5rem;
      margin-bottom: .5rem;
    }
    @media (min-width: 700px) {
      .layout-2 {
        display: grid;
        grid-template-columns: 1.05fr .95fr;
        gap: 1rem;
      }
    }
    /* Overlay / modal */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(2,6,23,0.6);
      backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
      padding: 1rem;
    }
    .overlay.active {
      display: flex;
    }
    .modal {
      background: #0f172a;
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 1.25rem;
      max-width: 520px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      padding: 1rem;
    }
    .modal h2 {
      margin-top: 0;
      font-size: 1rem;
    }
    .rpe-row {
      display: flex;
      justify-content: space-between;
      gap: .75rem;
      padding: .35rem .5rem;
      border-bottom: 1px solid rgba(148,163,184,0.1);
    }
    .rpe-row:last-child {
      border-bottom: none;
    }
    .rpe-num {
      font-weight: 600;
      min-width: 2.5rem;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>POTS Training Planner</h1>
        <div class="small">Rowing-first, 6 months no strength, interval start</div>
      </div>
      <div class="flex-row" style="gap:.4rem;">
        <button class="secondary-btn" id="rpeBtn">RPE guide</button>
        <button id="todayBtn">Today</button>
      </div>
    </header>

    <div class="card" id="controlsCard">
      <div class="flex-row" style="align-items:flex-end; gap:.75rem;">
        <div>
          <label for="startDate">Your Week 1 Monday</label>
          <input type="date" id="startDate" />
        </div>
        <div>
          <label for="weekSelect">Week</label>
          <select id="weekSelect"></select>
        </div>
        <div>
          <label for="daySelect">Day</label>
          <select id="daySelect">
            <option value="0">Monday</option>
            <option value="1">Tuesday</option>
            <option value="2">Wednesday</option>
            <option value="3">Thursday</option>
            <option value="4">Friday</option>
            <option value="5">Saturday</option>
            <option value="6">Sunday</option>
          </select>
        </div>
      </div>
      <div class="small" style="margin-top:.4rem;">
        Tip: change this if you want to start on a different Monday.
      </div>
    </div>

    <div class="layout-2">
      <div class="card" id="todayCard">
        <div class="today-title" id="todayLabel">Today</div>
        <div class="today-name" id="todayName"></div>
        <div class="badge" id="todayWeekBadge"></div>
        <div class="session-title" id="todaySessionTitle"></div>
        <div class="session-line" id="todayDetails"></div>
        <div class="session-line" id="todayDuration"></div>
        <div class="session-line" id="todayRPE"></div>
        <div class="session-line" id="todayNotes"></div>
        <button class="secondary-btn" id="howToBtn" style="margin-top:.6rem;">How to do this</button>
      </div>

      <div class="card">
        <div class="today-title" id="weekLabel">This week</div>
        <div class="week-grid" id="weekGrid"></div>
      </div>
    </div>

    <footer>
      Host on GitHub Pages → open on phone → “Add to Home Screen”.
    </footer>
  </div>

  <!-- RPE modal -->
  <div class="overlay" id="rpeOverlay">
    <div class="modal">
      <div class="flex-row" style="justify-content:space-between;align-items:center;">
        <h2>RPE Guide (POTS-friendly)</h2>
        <button class="secondary-btn" id="closeRpe">Close</button>
      </div>
      <p class="small">Use the low end on bad days.</p>
      <div class="rpe-row">
        <span class="rpe-num">6–7</span><span>Very easy / mobility / these 2-min rows. You could recover fast.</span>
      </div>
      <div class="rpe-row">
        <span class="rpe-num">8–10</span><span>Easy, conversational. Most early rows should feel like this.</span>
      </div>
      <div class="rpe-row">
        <span class="rpe-num">11–12</span><span>Comfortable-steady. Use later when you can row longer.</span>
      </div>
      <div class="rpe-row">
        <span class="rpe-num">13</span><span>Steady-moderate. Talking is shorter.</span>
      </div>
      <div class="rpe-row">
        <span class="rpe-num">14–15</span><span>Strong/tempo. Save for later phases.</span>
      </div>
      <div class="rpe-row">
        <span class="rpe-num">16</span><span>Hard interval. Only in later, stable weeks.</span>
      </div>
      <p class="small" style="margin-top:.6rem;">If dizziness, palpitations, or chest pain → stop and sit.</p>
    </div>
  </div>

  <!-- How-to modal -->
  <div class="overlay" id="howToOverlay">
    <div class="modal">
      <div class="flex-row" style="justify-content:space-between;align-items:center;">
        <h2 id="howToTitle">How to do this</h2>
        <button class="secondary-btn" id="closeHowTo">Close</button>
      </div>
      <div id="howToBody" class="small"></div>
    </div>
  </div>

  <script>
    // ----- HOW-TO DICTIONARY -----
    const HOW_TO = [
      {
        key: "row",
        title: "Seated row intervals – how to",
        body: `
          <p><strong>Setup:</strong> Strap feet so they don’t slip. Sit tall, slight forward lean from the hips.</p>
          <p><strong>Drive:</strong> Legs push → small lean back → arms pull to lower ribs.</p>
          <p><strong>Recovery:</strong> Arms out → lean forward → knees bend. Make recovery slower than the drive.</p>
          <p><strong>Intervals:</strong> After each 2–3 min bout, stay seated and breathe until symptoms settle, even if that takes longer than planned.</p>
        `
      },
      {
        key: "mobility",
        title: "Mobility / recovery",
        body: `
          <p>5–10 min of gentle neck, shoulders, thoracic rotations, hip flexor stretch.</p>
          <p>Finish with 3–5 min diaphragmatic breathing (one hand on belly, slow inhale, slow exhale).</p>
        `
      },
      {
        key: "strength",
        title: "Light KB / reintro strength",
        body: `
          <p>This starts around Week 25.</p>
          <p><strong>Goblet squat:</strong> KB at chest, sit to a box/chair, stand tall, breathe out on the way up, stop 2–3 reps before fatigue.</p>
          <p><strong>KB deadlift:</strong> KB between feet, hinge at hips, flat back, stand up.</p>
          <p>Rest seated between sets.</p>
        `
      }
    ];

    // ----- PLAN GENERATOR (early months = low-volume rowing only) -----
    function generatePlan() {
      const plan = [];
      const days = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];

      function make(week, dayIdx, type, details, duration, rpe, notes="") {
        return {
          week,
          dayIdx,
          dayName: days[dayIdx],
          session_type: type,
          details,
          duration,
          rpe,
          notes
        };
      }

      for (let w = 1; w <= 52; w++) {
        let sessions = [];

        // PHASE 1: Weeks 1–4 (very low, interval)
        if (w === 1) {
          sessions = [
            make(w,0,"Row – 3×2 min","3 × 2 min row @ RPE 6–7, 2–3 min seated rest after each.", "≈15–18", "6–7","Stay seated to recover."),
            make(w,1,"Mobility / breathing","Gentle mobility 5–10 min.", 10, "6–7",""),
            make(w,2,"Row – repeat","Same as Monday. If easy, you may do a 4th 2-min block.", "≈15–18", "6–7",""),
            make(w,3,"Rest / easy walk","Off or 5–10 min flat walk.", 10, "6–7","Stop if upright symptoms."),
            make(w,4,"Row – 3×2 min","3 × 2 min, 2–3 min rest.", "≈15–18", "6–7",""),
            make(w,5,"Optional short row","2 × 2 min, long rests.", "≈10–12", "6–7","Skip if tired."),
            make(w,6,"Rest","Full rest.", 0, "6–7","")
          ];
        } else if (w === 2) {
          sessions = [
            make(w,0,"Row – 4×2 min","4 × 2 min @ RPE 6–7, 2–3 min rest.", "≈18–20", "6–7",""),
            make(w,1,"Mobility / breathing","Gentle 5–10 min mobility.", 10, "6–7",""),
            make(w,2,"Row – 3×2 min (lighter)","3 × 2 min, 2–3 min rest.", "≈15–18", "6–7",""),
            make(w,3,"Rest / easy walk","Off or 5–10 min flat walk.", 10, "6–7",""),
            make(w,4,"Row – 4×2 min","4 × 2 min, 2–3 min rest.", "≈18–20", "6–7",""),
            make(w,5,"Optional 2×2 min","Short row.", "≈10–12", "6–7",""),
            make(w,6,"Rest","", 0, "6–7","")
          ];
        } else if (w === 3) {
          sessions = [
            make(w,0,"Row – 2×3 min + 2×2 min","2 × 3 min, then 2 × 2 min. All @ RPE 6–7. Rest 2–3 min.", "≈20", "6–7",""),
            make(w,1,"Mobility","5–10 min gentle.", 10, "6–7",""),
            make(w,2,"Row – 4×2 min","4 × 2 min, 2–3 min rest.", "≈18–20", "6–7",""),
            make(w,3,"Rest / easy walk","Off or 5–10 min walk.", 10, "6–7",""),
            make(w,4,"Row – 4×2 min","Repeat.", "≈18–20", "6–7",""),
            make(w,5,"Optional 2×2 min","Keep it easy.", "≈10–12", "6–7",""),
            make(w,6,"Rest","", 0, "6–7","")
          ];
        } else if (w === 4) {
          sessions = [
            make(w,0,"Row – 3×3 min","3 × 3 min @ RPE 6–7, 2–3 min rest.", "≈20", "6–7",""),
            make(w,1,"Mobility","", 10, "6–7",""),
            make(w,2,"Row – 4×2 min","4 × 2 min.", "≈18–20", "6–7",""),
            make(w,3,"Rest / easy walk","", 10, "6–7",""),
            make(w,4,"Row – 4×2 min","", "≈18–20", "6–7",""),
            make(w,5,"Optional 2×2 min","", "≈10–12", "6–7",""),
            make(w,6,"Rest","", 0, "6–7","")
          ];
        }
        // PHASE 1.5: Weeks 5–8 (still no strength, slightly longer)
        else if (w === 5) {
          sessions = [
            make(w,0,"Row – 3×3 min","3 × 3 min @ RPE 6–7, 2–3 min rest.", "≈20", "6–7",""),
            make(w,1,"Mobility","", 10, "6–7",""),
            make(w,2,"Row – 5×2 min","5 × 2 min @ RPE 6–7, 2 min rest.", "≈20", "6–7",""),
            make(w,3,"Rest / walk","", 10, "6–7",""),
            make(w,4,"Row – 3×3 min","", "≈20", "6–7",""),
            make(w,5,"Optional 2×2 min","", "≈10–12", "6–7",""),
            make(w,6,"Rest","", 0, "6–7","")
          ];
        } else if (w === 6) {
          sessions = [
            make(w,0,"Row – 4×3 min","4 × 3 min @ RPE 6–7, 2–3 min rest.", "≈25", "6–7",""),
            make(w,1,"Mobility","", 10, "6–7",""),
            make(w,2,"Row – 6×2 min","6 × 2 min, 1–2 min rest.", "≈22", "6–7",""),
            make(w,3,"Rest / walk","10–15 min flat, optional.", 15, "6–7",""),
            make(w,4,"Row – 10–15 min continuous (broken OK)","Row 3–5 min, pause, repeat to 10–15 min.", "10–15", "6–7","Micro-pauses OK."),
            make(w,5,"Optional 2×2 min","", "≈10–12", "6–7",""),
            make(w,6,"Rest","", 0, "6–7","")
          ];
        } else if (w === 7) {
          sessions = [
            make(w,0,"Row – 2×5 min + 2×2 min","2 × 5 min @ RPE 6–7, then 2 × 2 min. 2–3 min rest.", "≈25", "6–7",""),
            make(w,1,"Mobility","", 10, "6–7",""),
            make(w,2,"Row – 5×3 min","5 × 3 min, 2 min rest.", "≈25–28", "6–7",""),
            make(w,3,"Rest / walk","", 10, "6–7",""),
            make(w,4,"Row – 15–18 min continuous (broken ok)","", "15–18", "6–7","Pause as needed."),
            make(w,5,"Optional 2×3 min","", "≈10–12", "6–7",""),
            make(w,6,"Rest","", 0, "6–7","")
          ];
        } else if (w === 8) {
          sessions = [
            make(w,0,"Row – 3×3 min (deload)","", "≈18–20", "6–7","Deload week."),
            make(w,1,"Mobility","", 10, "6–7",""),
            make(w,2,"Row – 4×2 min","", "≈15–18", "6–7",""),
            make(w,3,"Rest / walk","", 10, "6–7",""),
            make(w,4,"Row – 10–12 min easy","", "10–12", "6–7",""),
            make(w,5,"Optional short row","", "8–10", "6–7",""),
            make(w,6,"Rest","", 0, "6–7","")
          ];
        }
        // PHASE 2: Weeks 9–12 (more "real" sessions, still rowing only)
        else if (w >= 9 && w <= 12) {
          const weekInPhase = w - 8; // 1..4
          // We'll slightly increase target total time
          const targetMain = 20 + (weekInPhase - 1) * 3; // 20,23,26,29
          sessions = [
            make(w,0,"Row – main day","Warm 3 min, then 2 × 6–8 min @ RPE 7, 2–3 min rest, then 2–3 min cool.", targetMain, "7","Break earlier if symptoms."),
            make(w,1,"Mobility","", 10, "6–7",""),
            make(w,2,"Row – interval day","6–8 × 2–3 min @ RPE 6–7, 1–2 min rest.", targetMain - 2, "6–7","Keep rests seated."),
            make(w,3,"Rest / walk","Short flat walk optional.", 10, "6–7",""),
            make(w,4,"Row – tolerance day","Try to stay on rower ~20–25 min total, micro-pauses OK.", targetMain, "6–7",""),
            make(w,5,"Optional very easy row","6–10 min.", 10, "6–7",""),
            make(w,6,"Rest","", 0, "6–7","")
          ];
        }
        // PHASE 3: Weeks 13–24 (build toward 30–35 min, still no strength)
        else if (w >= 13 && w <= 24) {
          const extra = Math.min(12, w - 12); // 1..12
          const baseMain = 20 + extra;        // grows to ~32
          sessions = [
            make(w,0,"Row – continuous-ish","5 min easy → 10–15 min @ RPE 7 → 5 min easy. Micro-pauses ok.", baseMain, "7",""),
            make(w,1,"Mobility / optional walk","", 10, "6–7",""),
            make(w,2,"Row – interval support","6 × 3 min @ RPE 7, 1–2 min rest.", baseMain - 2, "7","Sit between."),
            make(w,3,"Rest","", 0, "6–7",""),
            make(w,4,"Row – longer day","Build to 30–35 min total with short pauses.", Math.min(35, baseMain + 5), "6–7","Pause whenever needed."),
            make(w,5,"Optional short row","2–3 × 3 min.", 10, "6–7",""),
            make(w,6,"Rest","", 0, "6–7","")
          ];
        }
        // PHASE 4: Weeks 25–36 (reintroduce strength 1×, keep 3–4 row days)
        else if (w >= 25 && w <= 36) {
          const baseMain = 30; // you've earned 30-min-style days
          sessions = [
            make(w,0,"Row – steady","5 min easy → 15–20 min steady @ RPE 7 → 5 min easy.", baseMain, "7",""),
            make(w,1,"Strength – light KB / bodyweight","Goblet squat to chair, KB deadlift, 1-arm row. 1–2 sets. RPE 6–7.", 15, "6–7","Swap for easy row if bad day."),
            make(w,2,"Row – interval","6–8 × 3 min @ RPE 7–8, 1–2 min rest.", 28, "7–8",""),
            make(w,3,"Rest / mobility","", 10, "6–7",""),
            make(w,4,"Row – longer","30–35 min total, micro-pauses.", 35, "7",""),
            make(w,5,"Optional easy row","10–15 min.", 15, "6–7",""),
            make(w,6,"Rest","", 0, "6–7","")
          ];
        }
        // PHASE 5: Weeks 37–52 (maintenance, 4 row / 2 strength / 1 rest)
        else {
          sessions = [
            make(w,0,"Row – steady","5 min easy → 20 min @ RPE 7 → 5 min easy.", 30, "7",""),
            make(w,1,"Strength – light/moderate","KB goblet squat, deadlift, row, split squat. 2–3 sets, RPE 7.", 20, "7",""),
            make(w,2,"Row – intervals","6–8 × 3–4 min @ RPE 7–8, 1–2 min rest.", 32, "7–8",""),
            make(w,3,"Rest / mobility","", 10, "6–7",""),
            make(w,4,"Row – long / mix","30–40 min total, pauses ok.", 38, "7",""),
            make(w,5,"Strength – light","Repeat Tue or do bodyweight.", 15, "6–7",""),
            make(w,6,"Rest","", 0, "6–7","")
          ];
        }

        plan.push(...sessions);
      }

      return plan;
    }

    const PLAN = generatePlan();

    // ----- persistence -----
    function saveStartDate(dateStr) {
      localStorage.setItem("potsStartMonday", dateStr);
    }
    function loadStartDate() {
      return localStorage.getItem("potsStartMonday");
    }

    // ----- date helpers -----
    function daysBetween(d1, d2) {
      const one = new Date(d1.getFullYear(), d1.getMonth(), d1.getDate());
      const two = new Date(d2.getFullYear(), d2.getMonth(), d2.getDate());
      const diff = two - one;
      return Math.floor(diff / (1000*60*60*24));
    }

    // modified: if date is before start, show week 1 Monday
    function getSessionForDate(startMondayStr, dateObj) {
      const start = new Date(startMondayStr);
      const diffDays = daysBetween(start, dateObj);
      if (diffDays < 0) {
        // before the program start → just show Week 1 Monday
        return PLAN.find(s => s.week === 1 && s.dayIdx === 0);
      }
      const week = Math.floor(diffDays / 7) + 1;
      const dayIdx = diffDays % 7;
      if (week < 1 || week > 52) return { outOfRange: true, week, dayIdx };
      return PLAN.find(s => s.week === week && s.dayIdx === dayIdx);
    }

    // ----- UI refs -----
    const startDateInput = document.getElementById("startDate");
    const weekSelect = document.getElementById("weekSelect");
    const daySelect = document.getElementById("daySelect");
    const todayBtn = document.getElementById("todayBtn");
    const weekGrid = document.getElementById("weekGrid");
    const howToBtn = document.getElementById("howToBtn");
    const rpeBtn = document.getElementById("rpeBtn");
    const rpeOverlay = document.getElementById("rpeOverlay");
    const closeRpe = document.getElementById("closeRpe");
    const howToOverlay = document.getElementById("howToOverlay");
    const closeHowTo = document.getElementById("closeHowTo");
    const howToTitle = document.getElementById("howToTitle");
    const howToBody = document.getElementById("howToBody");

    function fillWeekSelect() {
      weekSelect.innerHTML = "";
      for (let w = 1; w <= 52; w++) {
        const opt = document.createElement("option");
        opt.value = w;
        opt.textContent = "Week " + w;
        weekSelect.appendChild(opt);
      }
    }

    function showSession(session, label="Today") {
      const tn = document.getElementById("todayName");
      const tw = document.getElementById("todayWeekBadge");
      const ts = document.getElementById("todaySessionTitle");
      const td = document.getElementById("todayDetails");
      const tdur = document.getElementById("todayDuration");
      const trpe = document.getElementById("todayRPE");
      const tnotes = document.getElementById("todayNotes");
      document.getElementById("todayLabel").textContent = label;

      if (!session) {
        tn.textContent = "No session found";
        tw.textContent = "";
        ts.textContent = "";
        td.textContent = "";
        tdur.textContent = "";
        trpe.textContent = "";
        tnotes.textContent = "";
        return;
      }

      tn.textContent = session.dayName;
      tw.textContent = "Week " + session.week;
      ts.textContent = session.session_type;
      td.textContent = session.details;
      tdur.textContent = "Duration: " + session.duration + " min";
      trpe.textContent = "RPE: " + session.rpe;
      tnotes.textContent = session.notes || "";
    }

    function renderWeek(week) {
      weekGrid.innerHTML = "";
      const sessions = PLAN.filter(s => s.week === week);
      sessions.forEach(s => {
        const div = document.createElement("div");
        div.className = "day-card";
        if (parseInt(daySelect.value, 10) === s.dayIdx) {
          div.classList.add("active");
        }
        div.innerHTML = `
          <div class="day-name">${s.dayName}</div>
          <div class="day-session">${s.session_type.split(" – ")[0]}</div>
          <div class="small">${s.duration} min • RPE ${s.rpe}</div>
        `;
        div.addEventListener("click", () => {
          daySelect.value = s.dayIdx;
          showSession(s, "Selected day");
          renderWeek(week);
        });
        weekGrid.appendChild(div);
      });
    }

    fillWeekSelect();

    // default start date: 2025-11-05 (your date), unless user saved something else
    const saved = loadStartDate();
    if (saved) {
      startDateInput.value = saved;
    } else {
      startDateInput.value = "2025-11-05";
      saveStartDate("2025-11-05");
    }

    function refreshToday() {
      const base = startDateInput.value;
      if (!base) return;
      const today = new Date();
      const sess = getSessionForDate(base, today);
      if (sess && !sess.outOfRange) {
        weekSelect.value = sess.week;
        daySelect.value = sess.dayIdx;
        showSession(sess, "Today");
        renderWeek(sess.week);
      } else {
        showSession(null, "Today");
      }
    }

    refreshToday();

    startDateInput.addEventListener("change", () => {
      if (startDateInput.value) {
        saveStartDate(startDateInput.value);
        refreshToday();
      }
    });

    weekSelect.addEventListener("change", () => {
      const week = parseInt(weekSelect.value, 10);
      renderWeek(week);
      const sess = PLAN.find(s => s.week === week && s.dayIdx === parseInt(daySelect.value,10));
      showSession(sess, "Selected day");
    });

    daySelect.addEventListener("change", () => {
      const week = parseInt(weekSelect.value, 10);
      const sess = PLAN.find(s => s.week === week && s.dayIdx === parseInt(daySelect.value,10));
      showSession(sess, "Selected day");
      renderWeek(week);
    });

    todayBtn.addEventListener("click", () => {
      refreshToday();
    });

    // RPE modal
    rpeBtn.addEventListener("click", () => {
      rpeOverlay.classList.add("active");
    });
    closeRpe.addEventListener("click", () => {
      rpeOverlay.classList.remove("active");
    });
    rpeOverlay.addEventListener("click", (e) => {
      if (e.target === rpeOverlay) rpeOverlay.classList.remove("active");
    });

    // How-to modal
    function showHowToForCurrent() {
      const week = parseInt(weekSelect.value, 10);
      const dayIdx = parseInt(daySelect.value, 10);
      const sess = PLAN.find(s => s.week === week && s.dayIdx === dayIdx);
      if (!sess) return;
      const lower = (sess.session_type || "").toLowerCase();

      let match = null;
      if (lower.includes("mobility") || lower.includes("rest")) {
        match = HOW_TO.find(h => h.key === "mobility");
      } else if (lower.includes("strength")) {
        match = HOW_TO.find(h => h.key === "strength");
      } else {
        // default to row guidance
        match = HOW_TO.find(h => h.key === "row");
      }

      howToTitle.textContent = match.title;
      howToBody.innerHTML = match.body;
      howToOverlay.classList.add("active");
    }

    howToBtn.addEventListener("click", showHowToForCurrent);
    closeHowTo.addEventListener("click", () => {
      howToOverlay.classList.remove("active");
    });
    howToOverlay.addEventListener("click", (e) => {
      if (e.target === howToOverlay) howToOverlay.classList.remove("active");
    });

    // service worker
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("sw.js").catch(() => {});
      });
    }
  </script>
</body>
</html>

