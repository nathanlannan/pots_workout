<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>POTS Training Planner</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0f172a" />
  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --card2: #1f2937;
      --accent: #38bdf8;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --radius: 1.25rem;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0%, #020617 55%, #000 100%);
      min-height: 100vh;
      color: var(--text);
      display: flex;
      justify-content: center;
    }
    .app {
      width: min(960px, 100%);
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: .75rem;
    }
    h1 {
      font-size: 1.2rem;
      margin: 0;
    }
    .card {
      background: rgba(15, 23, 42, 0.7);
      border: 1px solid rgba(148, 163, 184, 0.12);
      border-radius: var(--radius);
      padding: 1rem;
      backdrop-filter: blur(14px);
    }
    label {
      font-size: .7rem;
      display: block;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--muted);
      margin-bottom: .35rem;
    }
    input[type="date"], select {
      background: rgba(15, 23, 42, 0.7);
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: .75rem;
      padding: .35rem .6rem;
      color: var(--text);
    }
    button {
      background: var(--accent);
      border: none;
      border-radius: .75rem;
      color: #020617;
      padding: .4rem .8rem;
      font-weight: 600;
      cursor: pointer;
    }
    .secondary-btn {
      background: rgba(148, 163, 184, 0.1);
      border: 1px solid rgba(148, 163, 184, 0.25);
      color: var(--text);
    }
    .today-title {
      font-size: .75rem;
      text-transform: uppercase;
      color: var(--muted);
      letter-spacing: 0.04em;
      margin-bottom: .4rem;
    }
    .today-name {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: .25rem;
    }
    .badge {
      display: inline-block;
      background: rgba(56,189,248,0.1);
      border: 1px solid rgba(56,189,248,0.4);
      color: #e2e8f0;
      font-size: .6rem;
      padding: .2rem .5rem;
      border-radius: 999px;
      margin-right: .5rem;
    }
    .session-title {
      font-weight: 600;
      margin-top: .5rem;
      margin-bottom: .25rem;
    }
    .session-line {
      font-size: .8rem;
      color: var(--muted);
      margin-bottom: .25rem;
    }
    .flex-row {
      display: flex;
      gap: .5rem;
      flex-wrap: wrap;
    }
    .week-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: .5rem;
      margin-top: .5rem;
    }
    .day-card {
      background: rgba(248, 250, 252, 0.01);
      border: 1px solid rgba(148, 163, 184, 0.08);
      border-radius: 1rem;
      padding: .6rem .6rem .7rem;
      cursor: pointer;
    }
    .day-card.active {
      border-color: rgba(56,189,248,0.9);
      background: rgba(15,23,42,0.4);
    }
    .day-name {
      font-size: .65rem;
      text-transform: uppercase;
      color: var(--muted);
    }
    .day-session {
      font-size: .75rem;
      font-weight: 600;
    }
    .small {
      font-size: .7rem;
      color: var(--muted);
    }
    footer {
      text-align: center;
      font-size: .65rem;
      color: #475569;
      margin-top: .5rem;
      margin-bottom: .5rem;
    }
    @media (min-width: 700px) {
      .layout-2 {
        display: grid;
        grid-template-columns: 1.05fr .95fr;
        gap: 1rem;
      }
    }
    /* Overlay / modal */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(2,6,23,0.6);
      backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
      padding: 1rem;
    }
    .overlay.active {
      display: flex;
    }
    .modal {
      background: #0f172a;
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 1.25rem;
      max-width: 520px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      padding: 1rem;
    }
    .modal h2 {
      margin-top: 0;
      font-size: 1rem;
    }
    .rpe-row {
      display: flex;
      justify-content: space-between;
      gap: .75rem;
      padding: .35rem .5rem;
      border-bottom: 1px solid rgba(148,163,184,0.1);
    }
    .rpe-row:last-child {
      border-bottom: none;
    }
    .rpe-num {
      font-weight: 600;
      min-width: 2.5rem;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>POTS Training Planner</h1>
        <div class="small">1-year, RPE-based, rower + outdoor + KB</div>
      </div>
      <div class="flex-row" style="gap:.4rem;">
        <button class="secondary-btn" id="rpeBtn">RPE guide</button>
        <button id="todayBtn">Today</button>
      </div>
    </header>

    <div class="card" id="controlsCard">
      <div class="flex-row" style="align-items:flex-end; gap:.75rem;">
        <div>
          <label for="startDate">Your Week 1 Monday</label>
          <input type="date" id="startDate" />
        </div>
        <div>
          <label for="weekSelect">Week</label>
          <select id="weekSelect"></select>
        </div>
        <div>
          <label for="daySelect">Day</label>
          <select id="daySelect">
            <option value="0">Monday</option>
            <option value="1">Tuesday</option>
            <option value="2">Wednesday</option>
            <option value="3">Thursday</option>
            <option value="4">Friday</option>
            <option value="5">Saturday</option>
            <option value="6">Sunday</option>
          </select>
        </div>
      </div>
      <div class="small" style="margin-top:.4rem;">
        Tip: set this once and I'll remember it on this device.
      </div>
    </div>

    <div class="layout-2">
      <div class="card" id="todayCard">
        <div class="today-title" id="todayLabel">Today</div>
        <div class="today-name" id="todayName"></div>
        <div class="badge" id="todayWeekBadge"></div>
        <div class="session-title" id="todaySessionTitle"></div>
        <div class="session-line" id="todayDetails"></div>
        <div class="session-line" id="todayDuration"></div>
        <div class="session-line" id="todayRPE"></div>
        <div class="session-line" id="todayNotes"></div>
        <button class="secondary-btn" id="howToBtn" style="margin-top:.6rem;">How to do this</button>
      </div>

      <div class="card">
        <div class="today-title" id="weekLabel">This week</div>
        <div class="week-grid" id="weekGrid"></div>
      </div>
    </div>

    <footer>
      Host on GitHub Pages → open on phone → “Add to Home Screen”.
    </footer>
  </div>

  <!-- RPE modal -->
  <div class="overlay" id="rpeOverlay">
    <div class="modal">
      <div class="flex-row" style="justify-content:space-between;align-items:center;">
        <h2>RPE Guide (POTS-friendly)</h2>
        <button class="secondary-btn" id="closeRpe">Close</button>
      </div>
      <p class="small">Use the low end on rough/symptomatic days.</p>
      <div class="rpe-row">
        <span class="rpe-num">6–7</span><span>Very easy / mobility / warm-up. You could do this almost indefinitely.</span>
      </div>
      <div class="rpe-row">
        <span class="rpe-num">8–10</span><span>Easy. You can talk in full sentences. Recovery rows/walks.</span>
      </div>
      <div class="rpe-row">
        <span class="rpe-num">11–12</span><span>Comfortable-steady. You’re working but absolutely sustainable.</span>
      </div>
      <div class="rpe-row">
        <span class="rpe-num">13</span><span>Steady-moderate. You can talk, but prefer shorter phrases.</span>
      </div>
      <div class="rpe-row">
        <span class="rpe-num">14–15</span><span>Strong/tempo. Focused, breathing harder, you don’t want to do this too long.</span>
      </div>
      <div class="rpe-row">
        <span class="rpe-num">16</span><span>Hard interval. Short bouts only, follow with easy.</span>
      </div>
      <p class="small" style="margin-top:.6rem;">If symptoms jump (dizziness, HR spikes, chest discomfort), drop back to RPE 8–10 or stop.</p>
    </div>
  </div>

  <!-- How-to modal -->
  <div class="overlay" id="howToOverlay">
    <div class="modal">
      <div class="flex-row" style="justify-content:space-between;align-items:center;">
        <h2 id="howToTitle">How to do this</h2>
        <button class="secondary-btn" id="closeHowTo">Close</button>
      </div>
      <div id="howToBody" class="small"></div>
    </div>
  </div>

  <script>
    // --- FORM/EXERCISE DICTIONARY (broad, so it always hits) ---
    const HOW_TO = [
      {
        key: "strength",
        title: "Strength day – KB + bodyweight",
        body: `
          <p><strong>Goblet squat</strong><br>
          • Hold KB at chest, elbows down.<br>
          • Feet shoulder-ish width, toes slightly out.<br>
          • Sit hips back and down, chest tall.<br>
          • Only as low as you can control.<br>
          • Stand up, exhale. Leave 2–3 reps in the tank.</p>

          <p><strong>KB deadlift / hinge</strong><br>
          • KB between feet.<br>
          • Soft knees, push hips back, keep back flat.<br>
          • Grab KB, stand tall by pushing floor away.<br>
          • Control down. Don’t round.</p>

          <p><strong>1-arm KB row</strong><br>
          • One hand on bench/chair, back flat.<br>
          • Pull KB toward hip/ribs, squeeze shoulder blade.<br>
          • Lower slow.</p>

          <p><strong>Split squat to box (if listed)</strong><br>
          • Front foot flat, back foot behind.<br>
          • Drop straight down, light KB or just bodyweight.<br>
          • Use box/chair for safety.</p>

          <p><strong>Suitcase/farmer carries</strong><br>
          • Stand tall, KB at side, walk slow.<br>
          • Ribs down, no leaning.<br>
          • Stop if HR or symptoms rise.</p>

          <p><strong>POTS safety</strong><br>
          • Breathe every rep, no breath-holding.<br>
          • Sit between sets.<br>
          • If dizzy → stop, sit, feet up.</p>
        `
      },
      {
        key: "rower",
        title: "Rower – good form",
        body: `
          <p><strong>Setup:</strong> Strap feet, sit tall, slight forward lean from hips.</p>
          <p><strong>Drive:</strong> Legs push → body leans back a bit → arms pull to lower ribs.</p>
          <p><strong>Recovery:</strong> Arms out → body forward → knees bend (slow).</p>
          <p>Keep stroke smooth. Stay seated a bit after if lightheaded.</p>
        `
      },
      {
        key: "walk",
        title: "Outdoor walk – good form",
        body: `
          <p>Flat route, relaxed stride, arms swing naturally.</p>
          <p>Look ahead, don’t hunch.</p>
          <p>Compression + pre-hydration help upright tolerance.</p>
          <p>Stop and sit if symptoms show up.</p>
        `
      },
      {
        key: "long –",
        title: "Long session – how to",
        body: `
          <p>Keep most of the time at RPE 10–12.</p>
          <p>Short sip/breath breaks are totally okay.</p>
          <p>Mix upright + rower if upright is tiring.</p>
        `
      },
      {
        key: "rest / mobility",
        title: "Mobility / recovery",
        body: `
          <p>Neck circles, shoulder rolls, thoracic rotations, hip flexor stretch.</p>
          <p>Finish with 3–5 min diaphragmatic breathing.</p>
          <p>Goal: feel better after than before.</p>
        `
      }
    ];

    // --- PLAN GENERATOR ---
    function generatePlan() {
      const plan = [];
      const days = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];

      function make(week, dayIdx, session_type, details, duration, rpe, notes="") {
        return {
          week,
          dayIdx,
          dayName: days[dayIdx],
          session_type,
          details,
          duration,
          rpe,
          notes
        };
      }

      function deloadDuration(dur) {
        if (typeof dur === "string") {
          const parts = dur.replace("–","-").split("-");
          if (parts.length === 2) {
            const a = Math.max(10, Math.round(parseInt(parts[0],10) * 0.75));
            const b = Math.max(10, Math.round(parseInt(parts[1],10) * 0.75));
            return a + "-" + b;
          }
          return dur;
        } else {
          return Math.max(10, Math.round(dur * 0.75));
        }
      }

      for (let w = 1; w <= 52; w++) {
        let phase = "";
        if (w <= 8) phase = "Foundation";
        else if (w <= 16) phase = "Transition";
        else if (w <= 24) phase = "Build";
        else if (w <= 36) phase = "Consolidate";
        else phase = "Maintain";

        const isDeload = (w >= 12 && (w - 12) % 4 === 0);

        let Mon, Tue, Wed, Thu, Fri, Sat, Sun;

        if (phase === "Foundation") {
          const base = 25 + (w - 1) * 2;
          const long = 30 + (w - 1) * 3;

          Mon = make(w,0,"Aerobic – Rower (easy)","Continuous easy row.", base, "9–11","5 min warm-up & cool-down.");
          Tue = make(w,1,"Strength – KB + bodyweight","Goblet squat, KB deadlift, 1-arm row, dead bug, glute bridge. 2–3 sets, stop well before failure.", 20 + (w>4 ? 5:0), "6–7","");
          Wed = make(w,2,"Aerobic – Rower (easy)","Continuous easy row, relaxed stroke.", base, "9–11","");
          let thudetails, thudur, thurpe;
          if (w <= 4) {
            thudetails = "4×2 min @ RPE 12, 2 min very easy between; rest easy.";
            thudur = base;
            thurpe = "10–12";
          } else {
            thudetails = "4×3 min @ RPE 12–13, 3 min very easy; rest easy.";
            thudur = base + 5;
            thurpe = "11–13";
          }
          Thu = make(w,3,"Aerobic – Rower (steady pieces)", thudetails, thudur, thurpe, "Cooldown seated.");
          if (w >= 6) {
            Fri = make(w,4,"Upright – Outdoor walk (very easy)","Flat route, turn back early if symptoms.", 10 + (w-6)*2, "8–10","Swap to 15–20 min rower if upright is bad.");
          } else {
            Fri = make(w,4,"Aerobic – Rower (recovery)","Very easy rowing.", Math.max(15, base-5), "8–10","");
          }
          Sat = make(w,5,"Aerobic – Rower (long)","Continuous easy; short pauses ok.", long, "10–12","Compression & pre-hydration help.");
          Sun = make(w,6,"Rest / Mobility","Light mobility + breathing.", 15, "6–7","Rest fully if flared.");

        } else if (phase === "Transition") {
          const base = 35 + (w - 9) * 2;
          const long = 45 + (w - 9) * 3;

          Mon = make(w,0,"Aerobic – Rower (easy)","Continuous easy row.", base, "10–12","");
          Tue = make(w,1,"Strength – KB + bodyweight","3 sets: goblet squat, KB deadlift, 1-arm row, tall-kneeling press (optional), dead bug, bridge.", 30, "6–7","Skip overhead if symptomatic.");
          Wed = make(w,2,"Combo – Walk + Row","Walk 10–20 min easy, then 15–25 min easy row.", "30–40", "9–11","Row finish helps if upright is meh.");
          Thu = make(w,3,"Aerobic – Rower (steady/tempo)","5×3 min @ RPE 13–14 with 3 min very easy; finish easy.", base, "11–14","");
          Fri = make(w,4,"Upright – Outdoor walk","Continuous flat walk.", 15 + (w-9)*3, "10–12","Compression useful.");
          Sat = make(w,5,"Aerobic – Rower (long)","Build steady continuous row.", long, "11–13","");
          Sun = make(w,6,"Rest / Mobility","Gentle mobility + breathwork.", 15, "6–7","");

        } else if (phase === "Build") {
          const base = 40 + (w - 17);
          const long = 55 + (w - 17) * 2;

          Mon = make(w,0,"Upright – Outdoor walk (steady)","Flat walk; add 2–3×2 min brisk @ RPE 13 if ok.", base, "10–13","");
          Tue = make(w,1,"Strength – KB circuit","3 rounds @ RPE 7: goblet squat, KB deadlift, 1-arm row, split squat, carry.", 30, "7","");
          Wed = make(w,2,"Aerobic – Rower (easy)","Continuous easy row.", base, "10–12","");
          let thudetails, thurpe;
          if (w % 2 === 1) {
            thudetails = "Steady block: 15–20 min @ RPE 15 inside 45–60 min.";
            thurpe = "12–15";
          } else {
            thudetails = "6×3 min @ RPE 15 with 3 min very easy; total 45–60 min.";
            thurpe = "10–16";
          }
          Thu = make(w,3,"Quality – Rower or Walk", thudetails, "45–60", thurpe, "Choose row if upright symptoms higher.");
          Fri = make(w,4,"Recovery – row/walk","Short + very easy.", Math.max(25, base-10), "8–10","Rest if flared.");
          Sat = make(w,5,"Long – Row or mix","≥15–20 min upright somewhere.", long, "11–13","");
          Sun = make(w,6,"Rest / Mobility","Mobility + core activation.", 15, "6–7","");

        } else if (phase === "Consolidate") {
          const base = 45 + (w - 25);
          const long = 60 + (w - 25) * 2;

          Mon = make(w,0,"Upright – Outdoor walk (steady)","Add 3–4×2–3 min brisk @ RPE 13 if ok.", Math.min(base,55), "10–13","");
          Tue = make(w,1,"Strength – KB circuit","3–4 rounds @ RPE 7–8: goblet squat, KB deadlift, 1-arm row, hinge/swing technique, carry.", 35, "7–8","Only swing if stable.");
          Wed = make(w,2,"Aerobic – Rower (easy)","Continuous easy row.", Math.min(50,base), "10–12","");
          Thu = make(w,3,"Quality – Intervals","6–8×3 min @ RPE 15–16 with 3 min easy; total 50–60 min.", "50–60", "10–16","Pick row vs outdoors.");
          Fri = make(w,4,"Recovery – very easy","Short, conversational.", 30, "8–10","Optional rest.");
          Sat = make(w,5,"Long – choice","Row, walk, or mix.", Math.min(90,long), "11–13","");
          Sun = make(w,6,"Rest / Mobility","Mobility + breathing.", 15, "6–7","");

        } else {
          const base = 50;

          Mon = make(w,0,"Upright – walk/jog-walk","Walk steady; on good days 4–6×1 min brisk/jog @ RPE 14.", base, "10–14","Jog only if fully stable.");
          Tue = make(w,1,"Strength – KB circuit","3–4 rounds @ RPE 7–8: goblet squat, deadlift, row, split squat, carry.", 35, "7–8","");
          Wed = make(w,2,"Aerobic – Rower (easy)","Continuous easy row.", base, "10–12","");
          Thu = make(w,3,"Quality – choice","Alt steady 20–25 min @ RPE 15 and 6–8×3–4 min @ RPE 15–16.", "50–60", "10–16","");
          Fri = make(w,4,"Recovery – very easy","Short & easy; can be mobility.", 25, "8–10","");
          Sat = make(w,5,"Long – choice","70–90 min total. Mix upright + row.", "70–90", "11–13","");
          Sun = make(w,6,"Rest / Mobility","Full rest or mobility.", 15, "6–7","");
        }

        let sessions = [Mon, Tue, Wed, Thu, Fri, Sat, Sun];

        if (isDeload) {
          sessions = sessions.map(s => {
            const c = {...s};
            c.duration = deloadDuration(c.duration);
            c.notes = (c.notes ? c.notes + " " : "") + "Deload week: keep RPEs at low end.";
            return c;
          });
        }

        plan.push(...sessions);
      }
      return plan;
    }

    const PLAN = generatePlan();

    // --- persistence ---
    function saveStartDate(dateStr) {
      localStorage.setItem("potsStartMonday", dateStr);
    }
    function loadStartDate() {
      return localStorage.getItem("potsStartMonday");
    }

    // --- date helpers ---
    function daysBetween(d1, d2) {
      const one = new Date(d1.getFullYear(), d1.getMonth(), d1.getDate());
      const two = new Date(d2.getFullYear(), d2.getMonth(), d2.getDate());
      const diff = two - one;
      return Math.floor(diff / (1000*60*60*24));
    }

    function getSessionForDate(startMondayStr, dateObj) {
      const start = new Date(startMondayStr);
      const diffDays = daysBetween(start, dateObj);
      if (diffDays < 0) return null;
      const week = Math.floor(diffDays / 7) + 1;
      const dayIdx = diffDays % 7;
      if (week < 1 || week > 52) return { outOfRange: true, week, dayIdx };
      return PLAN.find(s => s.week === week && s.dayIdx === dayIdx);
    }

    // --- UI refs ---
    const startDateInput = document.getElementById("startDate");
    const weekSelect = document.getElementById("weekSelect");
    const daySelect = document.getElementById("daySelect");
    const todayBtn = document.getElementById("todayBtn");
    const weekGrid = document.getElementById("weekGrid");
    const howToBtn = document.getElementById("howToBtn");
    const rpeBtn = document.getElementById("rpeBtn");
    const rpeOverlay = document.getElementById("rpeOverlay");
    const closeRpe = document.getElementById("closeRpe");
    const howToOverlay = document.getElementById("howToOverlay");
    const closeHowTo = document.getElementById("closeHowTo");
    const howToTitle = document.getElementById("howToTitle");
    const howToBody = document.getElementById("howToBody");

    function fillWeekSelect() {
      weekSelect.innerHTML = "";
      for (let w = 1; w <= 52; w++) {
        const opt = document.createElement("option");
        opt.value = w;
        opt.textContent = "Week " + w;
        weekSelect.appendChild(opt);
      }
    }

    function showSession(session, label="Today") {
      const tn = document.getElementById("todayName");
      const tw = document.getElementById("todayWeekBadge");
      const ts = document.getElementById("todaySessionTitle");
      const td = document.getElementById("todayDetails");
      const tdur = document.getElementById("todayDuration");
      const trpe = document.getElementById("todayRPE");
      const tnotes = document.getElementById("todayNotes");
      document.getElementById("todayLabel").textContent = label;

      if (!session) {
        tn.textContent = "No session found";
        tw.textContent = "";
        ts.textContent = "";
        td.textContent = "";
        tdur.textContent = "";
        trpe.textContent = "";
        tnotes.textContent = "";
        return;
      }

      tn.textContent = session.dayName;
      tw.textContent = "Week " + session.week;
      ts.textContent = session.session_type;
      td.textContent = session.details;
      tdur.textContent = "Duration: " + session.duration + " min";
      trpe.textContent = "RPE: " + session.rpe;
      tnotes.textContent = session.notes || "";
    }

    function renderWeek(week) {
      weekGrid.innerHTML = "";
      const sessions = PLAN.filter(s => s.week === week);
      sessions.forEach(s => {
        const div = document.createElement("div");
        div.className = "day-card";
        if (parseInt(daySelect.value, 10) === s.dayIdx) {
          div.classList.add("active");
        }
        div.innerHTML = `
          <div class="day-name">${s.dayName}</div>
          <div class="day-session">${s.session_type.split(" – ")[0]}</div>
          <div class="small">${s.duration} min • RPE ${s.rpe}</div>
        `;
        div.addEventListener("click", () => {
          daySelect.value = s.dayIdx;
          showSession(s, "Selected day");
          renderWeek(week);
        });
        weekGrid.appendChild(div);
      });
    }

    fillWeekSelect();

    // load saved Monday or default to this week's Monday
    const saved = loadStartDate();
    if (saved) {
      startDateInput.value = saved;
    } else {
      const now = new Date();
      const day = now.getDay();
      const diffToMonday = (day === 0 ? -6 : 1 - day);
      const monday = new Date(now);
      monday.setDate(now.getDate() + diffToMonday);
      const iso = monday.toISOString().slice(0,10);
      startDateInput.value = iso;
      saveStartDate(iso);
    }

    function refreshToday() {
      const base = startDateInput.value;
      if (!base) return;
      const today = new Date();
      const sess = getSessionForDate(base, today);
      if (sess && !sess.outOfRange) {
        weekSelect.value = sess.week;
        daySelect.value = sess.dayIdx;
        showSession(sess, "Today");
        renderWeek(sess.week);
      } else {
        showSession(null, "Today");
      }
    }

    refreshToday();

    startDateInput.addEventListener("change", () => {
      if (startDateInput.value) {
        saveStartDate(startDateInput.value);
        refreshToday();
      }
    });

    weekSelect.addEventListener("change", () => {
      const week = parseInt(weekSelect.value, 10);
      renderWeek(week);
      const sess = PLAN.find(s => s.week === week && s.dayIdx === parseInt(daySelect.value,10));
      showSession(sess, "Selected day");
    });

    daySelect.addEventListener("change", () => {
      const week = parseInt(weekSelect.value, 10);
      const sess = PLAN.find(s => s.week === week && s.dayIdx === parseInt(daySelect.value,10));
      showSession(sess, "Selected day");
      renderWeek(week);
    });

    todayBtn.addEventListener("click", () => {
      refreshToday();
    });

    // RPE modal
    rpeBtn.addEventListener("click", () => {
      rpeOverlay.classList.add("active");
    });
    closeRpe.addEventListener("click", () => {
      rpeOverlay.classList.remove("active");
    });
    rpeOverlay.addEventListener("click", (e) => {
      if (e.target === rpeOverlay) rpeOverlay.classList.remove("active");
    });

    // How-to modal (fixed, broad match)
    function showHowToForCurrent() {
      const week = parseInt(weekSelect.value, 10);
      const dayIdx = parseInt(daySelect.value, 10);
      const sess = PLAN.find(s => s.week === week && s.dayIdx === dayIdx);
      if (!sess) return;

      const lowerTitle = (sess.session_type || "").toLowerCase();

      let match = null;
      if (lowerTitle.includes("strength")) {
        match = HOW_TO.find(h => h.key === "strength");
      } else if (lowerTitle.includes("rower")) {
        match = HOW_TO.find(h => h.key === "rower");
      } else if (lowerTitle.includes("walk")) {
        match = HOW_TO.find(h => h.key === "walk");
      } else if (lowerTitle.includes("long")) {
        match = HOW_TO.find(h => h.key === "long –");
      } else if (lowerTitle.includes("mobility") || lowerTitle.includes("rest")) {
        match = HOW_TO.find(h => h.key === "rest / mobility");
      }

      if (match) {
        howToTitle.textContent = match.title;
        howToBody.innerHTML = match.body;
      } else {
        howToTitle.textContent = "General form tips";
        howToBody.innerHTML = `
          <p>Keep breathing, no breath-holding.</p>
          <p>Pick the seated/rower option if upright is rough today.</p>
          <p>Stop for chest pain, severe dizziness, or vision change.</p>
        `;
      }

      howToOverlay.classList.add("active");
    }

    howToBtn.addEventListener("click", showHowToForCurrent);
    closeHowTo.addEventListener("click", () => {
      howToOverlay.classList.remove("active");
    });
    howToOverlay.addEventListener("click", (e) => {
      if (e.target === howToOverlay) howToOverlay.classList.remove("active");
    });

    // service worker
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("sw.js").catch(() => {});
      });
    }
  </script>
</body>
</html>
